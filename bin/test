#!/usr/bin/env python3

import unittest

from datetime import datetime

from service import AIRTABLE_MAP, Service


def serviceFactory(fields, id="a1b2c3d4"):

    return Service({"id": id, "fields": fields})


class testService(unittest.TestCase):
    def test_slug_field(self):

        service = serviceFactory({AIRTABLE_MAP["slug"]: "test-service"})
        self.assertEqual(service.slug, "test-service")

    def test_type_field(self):

        service = serviceFactory({AIRTABLE_MAP["type"]: "Regular Service"})
        self.assertEqual(service.type_field, "Regular Service")

    def test_service_name_field(self):

        service = serviceFactory({AIRTABLE_MAP["name"]: "Test Service"})
        self.assertEqual(service.name_field, "Test Service")

    def test_liturgical_name_field_returns_if_present(self):

        service = serviceFactory(
            {AIRTABLE_MAP["liturgical_name"]: "Test Liturgical Name"}
        )
        self.assertEqual(service.liturgical_name_field, "Test Liturgical Name")

    def test_liturgical_name_field_returns_none_if_missing(self):

        service = serviceFactory({})
        self.assertIsNone(service.liturgical_name_field)

    def test_technician_field(self):

        service = serviceFactory(
            {AIRTABLE_MAP["technician"]: {"name": "Test Technician"}}
        )
        self.assertEqual(service.technician_field, {"name": "Test Technician"})

    def test_technician_name_field(self):

        service_with_technician = serviceFactory(
            {AIRTABLE_MAP["technician"]: {"name": "Test Technician"}}
        )

        service_without_technician = serviceFactory({})

        self.assertEqual(service_with_technician.technician_name, "Test Technician")

        self.assertIsNone(service_without_technician.technician_name)

    def test_churchsuite_category_id(self):

        service = serviceFactory({AIRTABLE_MAP["churchsuite_category_id"]: "123"})
        self.assertEqual(service.churchsuite_category_id, "123")

    def test_order_of_service_id(self):

        service = serviceFactory({AIRTABLE_MAP["oos_id"]: "1234"})
        self.assertEqual(service.order_of_service_id, "1234")

    def test_podcast_id(self):

        service = serviceFactory({AIRTABLE_MAP["podcast_id"]: "2345"})
        self.assertEqual(service.podcast_id, "2345")

    def test_youtube_id(self):

        service = serviceFactory({AIRTABLE_MAP["youtube_id"]: "a1-b2_c3"})
        self.assertEqual(service.youtube_id, "a1-b2_c3")

    def test_churchsuite_image_field(self):
        service = serviceFactory(
            {AIRTABLE_MAP["churchsuite_image"]: {"id": "tEsTiMaGeId"}}
        )
        self.assertEqual(service.churchsuite_image_field, {"id": "tEsTiMaGeId"})

    def test_wordpress_image_id(self):

        service = serviceFactory({AIRTABLE_MAP["wp_image_id"]: "3456"})
        self.assertEqual(service.wordpress_image_id, "3456")

    def test_wordpress_image_last_uploaded_name(self):

        service = serviceFactory({AIRTABLE_MAP["wp_image_last_uploaded_name"]: "3456"})
        self.assertEqual(service.wordpress_image_last_uploaded_name, "3456")

    def test_datetime_field(self):

        service = serviceFactory({AIRTABLE_MAP["datetime"]: "2022-01-01T10:00:00.000Z"})
        self.assertEqual(service.datetime_field, "2022-01-01T10:00:00.000Z")

    def test_datetime(self):

        service = serviceFactory({AIRTABLE_MAP["datetime"]: "2022-01-01T10:00:00.000Z"})
        self.assertIsInstance(service.datetime, datetime)
        self.assertEqual(service.datetime.isoformat(), "2022-01-01T10:00:00+00:00")

        service_in_bst = serviceFactory(
            {AIRTABLE_MAP["datetime"]: "2022-08-01T09:00:00.000Z"}
        )
        self.assertEqual(
            service_in_bst.datetime.isoformat(), "2022-08-01T10:00:00+01:00"
        )

    def test_datetime_as_naive_string(self):

        service = serviceFactory({AIRTABLE_MAP["datetime"]: "2022-01-01T10:00:00.000Z"})
        self.assertEqual(service.datetime_as_naive_string, "2022-01-01 10:00:00")

        service_in_bst = serviceFactory(
            {AIRTABLE_MAP["datetime"]: "2022-08-01T09:00:00.000Z"}
        )
        self.assertEqual(service_in_bst.datetime_as_naive_string, "2022-08-01 10:00:00")

    def test_streaming_field(self):

        service = serviceFactory({AIRTABLE_MAP["streaming"]: "Yes"})
        self.assertEqual(service.streaming_field, "Yes")

    def test_is_streaming(self):

        service_streaming_yes = serviceFactory({AIRTABLE_MAP["streaming"]: "Yes"})

        service_streaming_no = serviceFactory({AIRTABLE_MAP["streaming"]: "No"})

        service_without_streaming = serviceFactory({})

        self.assertTrue(service_streaming_yes.is_streaming)

        self.assertFalse(service_streaming_no.is_streaming)

        self.assertFalse(service_without_streaming.is_streaming)

    def test_is_stream_public(self):

        service_public_yes = serviceFactory({AIRTABLE_MAP["stream_public"]: True})

        service_public_no = serviceFactory({})

        self.assertTrue(service_public_yes.is_stream_public)

        self.assertFalse(service_public_no.is_stream_public)

    def test_is_fee_payable(self):

        service_payable_yes = serviceFactory({AIRTABLE_MAP["fee_payable"]: True})

        service_payable_no = serviceFactory({})

        self.assertTrue(service_payable_yes.is_fee_payable)

        self.assertFalse(service_payable_no.is_fee_payable)

    def test_title_string(self):

        service_with_no_liturgical_name = serviceFactory(
            {AIRTABLE_MAP["name"]: "Test Service"}
        )

        service_with_liturgical_name = serviceFactory(
            {
                AIRTABLE_MAP["name"]: "Test Service",
                AIRTABLE_MAP["liturgical_name"]: "Test Liturgical Name",
            }
        )

        self.assertEqual(service_with_no_liturgical_name.title_string, "Test Service")

        self.assertEqual(
            service_with_liturgical_name.title_string, "Test Liturgical Name"
        )

    def test_title_string_with_date(self):

        service = serviceFactory(
            {
                AIRTABLE_MAP["name"]: "Test Service",
                AIRTABLE_MAP["datetime"]: "2022-01-01T10:00:00.000Z",
            }
        )

        self.assertEqual(service.title_string_with_date, "Test Service: 1 January 2022")

    def test_described_as(self):

        standard_service = serviceFactory({AIRTABLE_MAP["name"]: "Test Service"})

        said_eucharist_service = serviceFactory(
            {
                AIRTABLE_MAP["name"]: "Test Said Eucharist Service",
            }
        )

        sung_eucharist_service = serviceFactory(
            {
                AIRTABLE_MAP["name"]: "Test Sung Eucharist Service",
            }
        )

        evensong_service = serviceFactory(
            {
                AIRTABLE_MAP["name"]: "Test Choral Evensong Service",
                AIRTABLE_MAP["churchsuite_category_id"]: "34",
            }
        )

        self.assertEqual(standard_service.described_as, "service")
        self.assertEqual(said_eucharist_service.described_as, "service")
        self.assertEqual(sung_eucharist_service.described_as, "sung Eucharist")
        self.assertEqual(evensong_service.described_as, "service of Choral Evensong")

    def test_service_description(self):

        standard_service = serviceFactory({AIRTABLE_MAP["name"]: "Test Service"})

        sung_eucharist_service = serviceFactory(
            {
                AIRTABLE_MAP["name"]: "Test Sung Eucharist Service",
            }
        )

        sung_eucharist_with_liturgical_name_service = serviceFactory(
            {
                AIRTABLE_MAP["name"]: "Test Sung Eucharist Service",
                AIRTABLE_MAP[
                    "liturgical_name"
                ]: "the eleventy-first Sunday after Trinity",
            }
        )

        self.assertEqual(
            standard_service.description,
            "A service streamed live from St Mary's Church, Whitkirk.",
        )
        self.assertEqual(
            sung_eucharist_service.description,
            "A sung Eucharist streamed live from St Mary's Church, Whitkirk.",
        )
        self.assertEqual(
            sung_eucharist_with_liturgical_name_service.description,
            "A sung Eucharist streamed live from St Mary's Church, Whitkirk for the eleventy-first Sunday after Trinity.",
        )


if __name__ == "__main__":
    unittest.main()
